import streamlit as st
import json
from openai import OpenAI
from reportlab.pdfgen import canvas
from reportlab.lib.pagesizes import A4
from reportlab.lib.units import mm
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib import colors
import io

# --- 1. è¨­å®š ---
api_key = st.secrets["OPENAI_API_KEY"]
client = OpenAI(api_key=api_key)

# ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã®è¨­å®šï¼ˆã“ã“ã§è‰²ã‚’ä¸€æ‹¬ç®¡ç†ï¼‰
PRIMARY_COLOR = colors.HexColor("#E67E22") # è½ã¡ç€ã„ãŸã‚ªãƒ¬ãƒ³ã‚¸
ACCENT_COLOR = colors.HexColor("#FDEBD0")  # è–„ã„ã‚¯ãƒªãƒ¼ãƒ è‰²
TEXT_COLOR = colors.HexColor("#2C3E50")    # æ¿ƒã„ã‚°ãƒ¬ãƒ¼

# --- 2. AIé–¢æ•°ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å¼·åŒ–ï¼‰ ---
def generate_recipe_json(ingredients, mode, condition, target, user_message):
    prompt = f"""
    ã‚ãªãŸã¯ã€Œå®¶åº­æ–™ç†ã®ãƒ—ãƒ­ã€ã§ã™ã€‚
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œ{target}ã€ã¸ã®ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã¨ã—ã¦ãƒ¬ã‚·ãƒ”ã‚’ä½œã‚Šã¾ã™ã€‚
    ä»¥ä¸‹ã®æƒ…å ±ã‚’å…ƒã«ã€æŒ‡å®šã®JSONå½¢å¼ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

    ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã€‘
    * é£Ÿæ: {ingredients}
    * åŸºæœ¬ãƒ¢ãƒ¼ãƒ‰: {mode}
    * ãã®ä»–ã®æ¡ä»¶: {condition}
    * æ·»ãˆã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {user_message}

    ã€é‡è¦ãƒ«ãƒ¼ãƒ«ã€‘
    1. ææ–™ãƒªã‚¹ãƒˆã«ã¯ã€é‡èœãƒ»è‚‰ã ã‘ã§ãªãã€Œé†¤æ²¹ã€ã€Œç ‚ç³–ã€ãªã©ã®**èª¿å‘³æ–™ã¨ã€ãã®åˆ†é‡ã‚‚å¿…ãšã™ã¹ã¦ç¶²ç¾…ã™ã‚‹ã“ã¨**ã€‚
    2. æ‰‹é †ã®ä¸­ã§ã€Œåˆã‚ã›èª¿å‘³æ–™ã‚’å…¥ã‚Œã‚‹ã€ã¨ã™ã‚‹å ´åˆã€ãã®ä¸­èº«ãŒä½•ã‹ã‚‚æ˜ç¢ºã«ã™ã‚‹ã“ã¨ã€‚
    3. è¦ªã—ã¿ã‚„ã™ãã€ã‹ã¤èª­ã¿ã‚„ã™ã„æ–‡ç« ã«ã™ã‚‹ã“ã¨ã€‚

    ã€å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ(JSON)ã€‘
    {{
      "title": "æ–™ç†åï¼ˆã‚­ãƒ£ãƒƒãƒãƒ¼ã«ï¼‰",
      "cooking_time": "èª¿ç†æ™‚é–“ï¼ˆä¾‹ï¼š15åˆ†ï¼‰",
      "ingredients": [ 
        {{"name": "è±šè‚‰", "amount": "200g"}},
        {{"name": "é†¤æ²¹(A)", "amount": "å¤§ã•ã˜1"}},
        {{"name": "ã¿ã‚Šã‚“(A)", "amount": "å¤§ã•ã˜1"}}
      ],
      "preparation": [ "ä¸‹æº–å‚™1", "ä¸‹æº–å‚™2" ],
      "steps": [ "å·¥ç¨‹1", "å·¥ç¨‹2" ],
      "chef_comment": "ã‚·ã‚§ãƒ•ã‹ã‚‰ã®ãƒ¯ãƒ³ãƒã‚¤ãƒ³ãƒˆã‚¢ãƒ‰ãƒã‚¤ã‚¹"
    }}
    """

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": prompt}],
        response_format={"type": "json_object"}
    )
    return json.loads(response.choices[0].message.content)

# --- 3. PDFè£…é£¾ç”¨ã®é–¢æ•°ï¼ˆæ ç·šãªã©ã‚’æç”»ï¼‰ ---
def draw_page_frame(canvas, doc):
    canvas.saveState()
    # ãƒšãƒ¼ã‚¸å…¨ä½“ã®å¤–æ 
    canvas.setStrokeColor(PRIMARY_COLOR)
    canvas.setLineWidth(2)
    canvas.rect(10*mm, 10*mm, 190*mm, 277*mm) # A4ã‚µã‚¤ã‚ºã®å†…å´ã«æ ã‚’æã
    
    # ãƒ•ãƒƒã‚¿ãƒ¼
    canvas.setFont("Helvetica", 9)
    canvas.setFillColor(colors.grey)
    canvas.drawCentredString(A4[0]/2, 15*mm, "Generated by AI Recipe Gift")
    canvas.restoreState()

# --- 4. PDFç”Ÿæˆé–¢æ•°ï¼ˆãƒ‡ã‚¶ã‚¤ãƒ³å¼·åŒ–ç‰ˆï¼‰ ---
def create_pdf_bytes(data, target_name, user_message_content):
    buffer = io.BytesIO()
    doc = SimpleDocTemplate(buffer, pagesize=A4,
                            rightMargin=20*mm, leftMargin=20*mm,
                            topMargin=20*mm, bottomMargin=25*mm)
    
    # ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š
    font_path = "ipaexg.ttf" 
    try:
        pdfmetrics.registerFont(TTFont('JapaneseFont', font_path))
    except:
        st.error("ã‚¨ãƒ©ãƒ¼: ipaexg.ttf ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
        return None

    # ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©
    styles = getSampleStyleSheet()
    
    # ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¿ã‚¤ãƒ«
    title_style = ParagraphStyle(
        name='TitleJp', fontName='JapaneseFont', fontSize=26, leading=32, 
        alignment=1, spaceAfter=10, textColor=PRIMARY_COLOR
    )
    # ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆFor ã€‡ã€‡ï¼‰
    subtitle_style = ParagraphStyle(
        name='SubTitleJp', fontName='JapaneseFont', fontSize=14, leading=20, 
        alignment=1, spaceAfter=20, textColor=colors.grey
    )
    # è¦‹å‡ºã—ã‚¹ã‚¿ã‚¤ãƒ«
    heading_style = ParagraphStyle(
        name='HeadingJp', fontName='JapaneseFont', fontSize=16, leading=20, 
        spaceBefore=15, spaceAfter=10, textColor=TEXT_COLOR,
        borderPadding=5, borderWidth=0, backColor=None
    )
    # æœ¬æ–‡ã‚¹ã‚¿ã‚¤ãƒ«
    body_style = ParagraphStyle(
        name='BodyJp', fontName='JapaneseFont', fontSize=11, leading=16, textColor=TEXT_COLOR
    )

    story = []

    # 1. ã‚¿ã‚¤ãƒˆãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    story.append(Paragraph(data['title'], title_style))
    story.append(Paragraph(f"For: {target_name}  |  â± {data['cooking_time']}", subtitle_style))
    story.append(Spacer(1, 5*mm))

    # 2. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ãƒ¼ãƒ‰ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
    if user_message_content:
        # ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ã£ã¦ã€Œã‚«ãƒ¼ãƒ‰é¢¨ã€ã®èƒŒæ™¯ã‚’ä½œã‚‹
        msg_content = Paragraph(f"<b>Message:</b><br/>{user_message_content}", 
                                ParagraphStyle(name='MsgInside', fontName='JapaneseFont', fontSize=12, leading=18))
        msg_table = Table([[msg_content]], colWidths=[160*mm])
        msg_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, -1), ACCENT_COLOR), # èƒŒæ™¯è‰²
            ('BOX', (0, 0), (-1, -1), 1, PRIMARY_COLOR),    # æ ç·š
            ('ROUNDEDCORNERS', [5, 5, 5, 5]),               # è§’ä¸¸ï¼ˆReportLabã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚ˆã£ã¦ã¯åŠ¹ã‹ãªã„å ´åˆã‚ã‚Šï¼‰
            ('PADDING', (0, 0), (-1, -1), 15),              # ä½™ç™½
            ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ]))
        story.append(msg_table)
        story.append(Spacer(1, 10*mm))

    # 3. ææ–™ãƒªã‚¹ãƒˆï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ã§è¦‹ã‚„ã™ãï¼‰
    story.append(Paragraph("ğŸ›’ ææ–™ (Ingredients)", heading_style))
    
    ing_data = []
    # ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã¯ãªã—ã§ã€ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ç¶ºéº—ã«ä¸¦ã¹ã‚‹
    for item in data['ingredients']:
        ing_data.append([item['name'], item['amount']])
    
    t_ing = Table(ing_data, colWidths=[100*mm, 40*mm])
    t_ing.setStyle(TableStyle([
        ('FONT', (0, 0), (-1, -1), 'JapaneseFont', 11),
        ('TEXTCOLOR', (0, 0), (-1, -1), TEXT_COLOR),
        ('LINEBELOW', (0, 0), (-1, -1), 0.5, colors.lightgrey), # ä¸‹ç·š
        ('VALIGN', (0, 0), (-1, -1), 'MIDDLE'),
        ('PADDING', (0, 0), (-1, -1), 6),
    ]))
    story.append(t_ing)
    story.append(Spacer(1, 8*mm))

    # 4. ä½œã‚Šæ–¹
    story.append(Paragraph("ğŸ³ ä½œã‚Šæ–¹ (Steps)", heading_style))
    
    # ä¸‹æº–å‚™
    if data['preparation']:
        story.append(Paragraph("<b>ã€ä¸‹æº–å‚™ã€‘</b>", body_style))
        for prep in data['preparation']:
            story.append(Paragraph(f"ãƒ»{prep}", body_style))
        story.append(Spacer(1, 3*mm))

    # æœ¬å·¥ç¨‹ï¼ˆç•ªå·ä»˜ãï¼‰
    for i, step in enumerate(data['steps'], 1):
        # å·¥ç¨‹ç•ªå·ã‚’ç›®ç«‹ãŸã›ã‚‹
        story.append(Paragraph(f"<b>Step {i}:</b> {step}", body_style))
        story.append(Spacer(1, 2*mm))

    # 5. ã‚·ã‚§ãƒ•ã®ã‚³ãƒ¡ãƒ³ãƒˆ
    if 'chef_comment' in data:
        story.append(Spacer(1, 5*mm))
        story.append(Paragraph("ğŸ‘¨â€ğŸ³ Chef's Point", heading_style))
        story.append(Paragraph(data['chef_comment'], body_style))

    # ãƒ“ãƒ«ãƒ‰ï¼ˆãƒšãƒ¼ã‚¸è£…é£¾é–¢æ•°ã‚’é©ç”¨ï¼‰
    doc.build(story, onFirstPage=draw_page_frame, onLaterPages=draw_page_frame)
    buffer.seek(0)
    return buffer

# --- 5. Streamlit ç”»é¢æ§‹ç¯‰ ---
def main():
    st.set_page_config(page_title="Recipe Gift", page_icon="ğŸ") # ã‚¿ãƒ–è¡¨ç¤ºã®è¨­å®š
    
    st.title("ğŸ AI Recipe Gift Generator")
    st.markdown("å¤§åˆ‡ãªäººã¸ã€**ä¸–ç•Œã«ä¸€ã¤ã®ãƒ¬ã‚·ãƒ”**ã‚’è´ˆã‚Šã¾ã—ã‚‡ã†ã€‚")

    with st.sidebar:
        st.header("ğŸ“ ãƒ¬ã‚·ãƒ”ã®è¨­å®š")
        ingredients = st.text_area("é£Ÿæãƒªã‚¹ãƒˆ", "è±šè‚‰ã€ç‰ã­ãã€äººå‚")
        target = st.text_input("è´ˆã‚‹ç›¸æ‰‹", "ãŠæ¯ã•ã‚“")
        mode = st.selectbox("ãƒ¢ãƒ¼ãƒ‰", ["å†·è”µåº«ã®ã‚‚ã®ã§ä½œã‚‹", "è²·ã„ç‰©ã—ã¦è±ªè¯ã«"])
        condition = st.text_input("å¥½ã¿ãƒ»æ¡ä»¶", "å’Œé£Ÿã€ã”é£¯ãŒé€²ã‚€å‘³ã€é‡èœå¤šã‚")
        user_message = st.text_area("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚«ãƒ¼ãƒ‰ã®å†…å®¹", "ã„ã¤ã‚‚ç¾å‘³ã—ã„ã”é£¯ã‚’ã‚ã‚ŠãŒã¨ã†ï¼ãŸã¾ã«ã¯ã‚†ã£ãã‚Šä¼‘ã‚“ã§ã­ã€‚")
        
        generate_btn = st.button("ğŸ ã‚®ãƒ•ãƒˆã‚’ä½œã‚‹", type="primary")

    if generate_btn:
        with st.spinner("ã‚·ã‚§ãƒ•ãŒãƒ¬ã‚·ãƒ”ã‚’è€ƒæ¡ˆä¸­..."):
            # AIç”Ÿæˆ
            recipe_data = generate_recipe_json(ingredients, mode, condition, target, user_message)
            
            # --- Webç”»é¢è¡¨ç¤ºã‚¨ãƒªã‚¢ ---
            st.markdown("---")
            col1, col2 = st.columns([2, 1])
            
            with col1:
                st.header(recipe_data['title'])
                st.caption(f"For: {target} | â± {recipe_data['cooking_time']}")
                
                if user_message:
                    st.info(f"{user_message}")

                st.subheader("ğŸ›’ ææ–™")
                # ææ–™ã‚’Markdownã®è¡¨å½¢å¼ã§è¡¨ç¤º
                md_table = "| é£Ÿæ | åˆ†é‡ |\n|---|---|\n"
                for item in recipe_data['ingredients']:
                    md_table += f"| {item['name']} | {item['amount']} |\n"
                st.markdown(md_table)

            with col2:
                # ä½œã‚Šæ–¹ã‚’å³å´ã«ï¼ˆã‚¹ãƒãƒ›ã ã¨ä¸‹ã«æ¥ã¾ã™ï¼‰
                st.subheader("ğŸ³ ä½œã‚Šæ–¹")
                for i, step in enumerate(recipe_data['steps'], 1):
                    st.write(f"**{i}.** {step}")
            
            # --- PDFç”Ÿæˆ & ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ---
            st.markdown("---")
            st.subheader("ğŸ å®Œæˆã—ãŸã‚®ãƒ•ãƒˆ")
            pdf_bytes = create_pdf_bytes(recipe_data, target, user_message)
            
            if pdf_bytes:
                st.download_button(
                    label="ğŸ“„ ã‚®ãƒ•ãƒˆPDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                    data=pdf_bytes,
                    file_name="recipe_gift.pdf",
                    mime="application/pdf",
                    use_container_width=True # ãƒœã‚¿ãƒ³ã‚’æ¨ªå¹…ã„ã£ã±ã„ã«
                )

if __name__ == "__main__":
    main()

